# Disimpy Integration for CATERPillar

This directory contains the tools to run [Disimpy](https://github.com/kerkelae/disimpy) simulations on geometric substrates generated by [CATERPillar](https://github.com/m-hough/CATERPillar).

## Prerequisites

- NVIDIA GPU with CUDA drivers installed (host).
- NVIDIA Docker (nكدia-container-toolkit).

## Setup

1. **Build the Container**
   Run the build script to create the `disimpy-ngc:25.12` image.
   ```bash
   ./build_container.sh
   ```

## Usage

### 1. Generate Signal from CATERPillar Spheres

Use the `run_caterpillar_disimpy.py` script inside the container. You need to mount your data directories.

```bash
# Example
docker run --gpus all -v /path/to/data:/data -v $(pwd):/app disimpy-ngc:25.12 \
    python /app/run_caterpillar_disimpy.py \
    --spheres /data/caterpillar_output/spheres.csv \
    --output /data/signal_disimpy.npy \
    --mesh_mode concat
```

### 2. Mesh Modes

- `--mesh_mode concat`: Fast. Concatenates all sphere meshes. Walkers might reflect off internal walls of overlapping spheres (physically incorrect for "intra-axonal" if spheres model a continuous tube).
- `--mesh_mode union`: Slow. Computes the boolean union of all spheres to create a true boundary. Use this for rigorous validation.

## Wrapper Script Details

The `run_caterpillar_disimpy.py` script performs the following:
1. Loads sphere coordinates and radii from the CSV.
2. Generates a triangular mesh using `trimesh` (icospheres).
3. Converts the mesh to `disimpy`'s substrate format.
4. Initializes a random walk simulation on the GPU.
5. Saves the resulting synthetic dMRI signal.
